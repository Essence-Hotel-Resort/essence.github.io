<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essence Hotel & Resort Command</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, limit, addDoc, serverTimestamp, arrayUnion, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables will be set here
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.writeUpdate = updateProfile;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendEmailVerification = sendEmailVerification;
        window.updateProfile = updateProfile;
        
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.limit = limit;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.arrayUnion = arrayUnion;
        window.getDocs = getDocs;
        window.setLogLevel = setLogLevel;
        window.orderBy = orderBy;
    </script>
    <style>
        /* Custom Lofi/Futuristic Red Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; /* bg-gray-900 */
        }
        ::-webkit-scrollbar-thumb {
            background: #dc2626; /* bg-red-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #b91c1c; /* darker red */
        }

        /* Set the Inter font as default and ensure full screen */
        body { font-family: 'Inter', sans-serif; }

        /* General Button Styling for the app */
        .app-btn {
            @apply bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md shadow-red-900/50;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            @apply fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50;
        }

        /* Input Styling */
        .app-input {
            @apply w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            text-align: left;
            border-radius: 0.5rem;
            transition: background-color 150ms;
            color: #d1d5db; /* text-gray-300 */
        }
        .nav-item:hover {
            background-color: #450a0a; /* bg-red-900/50 */
        }
        .admin-tab {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: #9ca3af; /* text-gray-400 */
            border-bottom: 2px solid transparent;
            transition: all 200ms;
        }
        .admin-tab:hover {
            color: #fca5a5; /* text-red-300 */
        }
        .admin-tab.active {
            color: #f87171; /* text-red-400 */
            border-bottom-color: #dc2626; /* border-red-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <div id="app-container" class="flex flex-col flex-grow">
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
                <p class="text-lg text-red-500">Initializing Core Systems...</p>
            </div>
        </div>

        <!-- Header (Navigation Bar) - Always Visible for App View -->
        <header id="app-header" class="bg-gray-800 shadow-xl p-4 flex justify-between items-center z-10 sticky top-0 border-b border-red-900/50 hidden">
            <h1 class="text-2xl font-bold text-red-500 tracking-wider">
                <span class="hidden sm:inline">ESSENCE HOTEL & RESORT</span> // COMMAND CENTER
            </h1>
            <div class="flex items-center space-x-4">
                <button id="profile-btn" onclick="setView('profile')" class="flex items-center space-x-2 p-2 rounded-full hover:bg-red-900/50 transition duration-150">
                    <img id="profile-avatar" src="https://placehold.co/40x40/1f2937/ffffff?text=U" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-red-500 object-cover">
                    <span id="profile-name" class="font-medium hidden sm:inline">User</span>
                </button>
                <button onclick="handleSignOut()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-2 px-4 rounded-lg transition duration-150 text-sm">Sign Out</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex flex-grow overflow-hidden">
            <!-- Landing View (Default Unauthenticated View) -->
            <div id="landing-view" class="view-container flex-grow flex items-center justify-center p-8">
                <div class="text-center max-w-2xl bg-gray-800/80 p-10 rounded-xl shadow-2xl border border-red-700/50">
                    <h1 class="text-5xl font-extrabold text-red-500 mb-4 tracking-tight">Essence Hotel & Resort</h1>
                    <p class="text-gray-300 text-xl mb-8">Your Galactic Command Center for updates, direct communications, and support services.</p>
                    <div class="space-x-4">
                        <button onclick="showModal('login')" class="app-btn px-8">LOGIN</button>
                        <button onclick="showModal('signup')" class="app-btn px-8 bg-gray-600 hover:bg-gray-700">SIGN UP</button>
                    </div>
                    <p id="auth-error-message" class="text-red-400 mt-4 hidden"></p>
                </div>
            </div>

            <!-- Verification View (Email Not Verified) -->
            <div id="verify-view" class="view-container flex-grow flex items-center justify-center p-8 hidden">
                <div class="text-center max-w-lg bg-yellow-900/40 p-10 rounded-xl shadow-2xl border border-yellow-700/50">
                    <h2 class="text-3xl font-bold text-yellow-300 mb-4">Action Required: Verify Email</h2>
                    <p class="text-gray-200 mb-6">Please check your inbox (and spam folder) for a verification link sent to your email address.</p>
                    <div class="space-y-4">
                        <button onclick="sendVerificationEmail(true)" class="app-btn px-8 bg-yellow-600 hover:bg-yellow-700">Resend Email</button>
                        <button onclick="handleSignOut()" class="app-btn px-8 bg-gray-600 hover:bg-gray-700">Sign Out</button>
                    </div>
                </div>
            </div>

            <!-- Application View (Authenticated) -->
            <div id="app-view" class="view-container flex-grow overflow-hidden hidden flex">
                <!-- Sidebar Navigation -->
                <nav class="w-16 sm:w-64 bg-gray-800/80 p-4 border-r border-red-900/50 flex flex-col space-y-4 shadow-2xl transition-all duration-300 flex-shrink-0">
                    <button onclick="setView('posts')" class="nav-item">
                        <span class="text-red-500 text-xl">üì∞</span>
                        <span class="hidden sm:inline">Posts/Updates</span>
                    </button>
                    <button onclick="setView('dms')" class="nav-item">
                        <span class="text-red-500 text-xl">üí¨</span>
                        <span class="hidden sm:inline">Direct Messages</span>
                    </button>
                    <button onclick="setView('profile')" class="nav-item">
                        <span class="text-red-500 text-xl">‚öôÔ∏è</span>
                        <span class="hidden sm:inline">Settings</span>
                    </button>
                    <!-- Admin Button (Hidden by default) -->
                    <button id="admin-nav-btn" onclick="setView('admin')" class="nav-item hidden">
                        <span class="text-red-500 text-xl">üëë</span>
                        <span class="hidden sm:inline">Admin Panel</span>
                    </button>
                </nav>

                <!-- Content Viewer -->
                <div id="content-viewer" class="flex-grow p-4 sm:p-8 overflow-y-auto">
                    <!-- Posts View (Default) -->
                    <div id="posts-view" class="view-content">
                        <h2 class="text-3xl font-light mb-6 text-red-400 border-b border-red-700/50 pb-2">Latest Updates</h2>
                        <div id="posts-list" class="space-y-6">
                            <!-- Posts will be injected here -->
                        </div>
                    </div>

                    <!-- DMs View (List or Thread) -->
                    <div id="dms-view" class="view-content hidden h-full flex flex-col">
                        <h2 id="dm-header" class="text-3xl font-light mb-6 text-red-400 border-b border-red-700/50 pb-2">Direct Messages</h2>

                        <!-- DM List -->
                        <div id="dm-list-container" class="flex-grow overflow-y-auto">
                            <p class="text-gray-400 italic mb-4">Start a new chat by entering a User ID below (find IDs in Settings).</p>
                            <div class="flex mb-6 space-x-2">
                                <input id="new-dm-id" type="text" placeholder="Enter User ID (e.g., QWERTASDFG1234)" class="app-input flex-grow">
                                <button onclick="startNewDM()" class="app-btn">
                                    Start Chat
                                </button>
                            </div>
                            <h3 class="text-xl font-medium text-gray-300 mb-3">Active Chats</h3>
                            <div id="dm-active-list" class="space-y-2">
                                <!-- DM List items injected here -->
                            </div>
                        </div>

                        <!-- DM Thread (Hidden initially) -->
                        <div id="dm-thread-container" class="hidden flex-col h-full bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-3 flex-shrink-0">
                                <h3 id="dm-thread-title" class="text-2xl font-bold text-red-500 truncate">Chat with [User]</h3>
                                <button onclick="closeDMThread()" class="text-gray-400 hover:text-red-500 transition duration-150 text-xl ml-4">&times;</button>
                            </div>
                            <div id="dm-messages" class="flex-grow overflow-y-auto space-y-4 mb-4 p-2 bg-gray-900 rounded-lg">
                                <!-- Messages injected here -->
                            </div>
                            <div class="flex space-x-2 flex-shrink-0">
                                <input id="dm-input" type="text" placeholder="Send a direct message..." class="app-input flex-grow">
                                <button onclick="sendDM()" class="app-btn">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile View -->
                    <div id="profile-view" class="view-content hidden max-w-lg mx-auto bg-gray-800 p-6 rounded-xl shadow-2xl border border-red-900/50">
                        <h2 class="text-3xl font-light mb-6 text-red-400">User Profile & Settings</h2>
                        <div class="text-center mb-6">
                            <img id="profile-edit-avatar" src="https://placehold.co/100x100/1f2937/ffffff?text=U" alt="User Avatar" class="w-24 h-24 rounded-full border-4 border-red-500 object-cover mx-auto mb-4">
                            <p class="text-gray-400 text-sm">Your unique User ID (share this to receive DMs):</p>
                            <p id="current-user-id" class="text-red-500 font-mono text-lg break-all p-2 bg-gray-700 rounded-lg select-all"></p>
                        </div>

                        <form id="profile-form" class="space-y-4">
                            <div>
                                <label for="name-input" class="block text-sm font-medium text-gray-300">Display Name</label>
                                <input type="text" id="name-input" class="app-input" required>
                            </div>
                            <div>
                                <label for="image-url-input" class="block text-sm font-medium text-gray-300">Avatar Image URL</label>
                                <input type="url" id="image-url-input" class="app-input" placeholder="https://..." required>
                            </div>
                            <button type="submit" class="w-full app-btn">
                                Save Profile
                            </button>
                        </form>
                    </div>

                    <!-- Admin View (Admin-only) -->
                    <div id="admin-view" class="view-content hidden">
                        <h2 class="text-3xl font-light mb-6 text-red-400 border-b border-red-700/50 pb-2">ADMIN COMMAND PANEL</h2>

                        <!-- Admin Tabs -->
                        <div class="flex space-x-4 mb-6 border-b border-gray-700">
                            <button id="tab-posts" onclick="setAdminTab('posts')" class="admin-tab active">Create Update Post</button>
                            <button id="tab-users" onclick="setAdminTab('users')" class="admin-tab">View Users</button>
                        </div>

                        <!-- Admin: Create Post Tab -->
                        <div id="admin-posts-tab" class="admin-tab-content">
                            <h3 class="text-xl font-medium text-gray-300 mb-4">Publish New Hotel Update</h3>
                            <form id="post-form" class="space-y-4 bg-gray-800 p-6 rounded-xl">
                                <div>
                                    <label for="post-title" class="block text-sm font-medium text-gray-300">Title</label>
                                    <input type="text" id="post-title" class="app-input" required>
                                </div>
                                <div>
                                    <label for="post-content" class="block text-sm font-medium text-gray-300">Content</label>
                                    <textarea id="post-content" rows="5" class="app-input" required></textarea>
                                </div>
                                <button type="submit" class="app-btn">
                                    POST UPDATE
                                </button>
                            </form>
                        </div>

                        <!-- Admin: View Users Tab -->
                        <div id="admin-users-tab" class="admin-tab-content hidden">
                            <h3 class="text-xl font-medium text-gray-300 mb-4">Current Registered Users</h3>
                            <div id="users-list-container" class="space-y-3">
                                <!-- User info cards injected here -->
                                <p id="users-loading-message" class="text-gray-400">Loading user data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal-backdrop hidden" onclick="hideModal(event, 'login')">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border border-red-700/50" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-red-500 mb-4">Login</h3>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="app-input" required>
                <input type="password" id="login-password" placeholder="Password" class="app-input" required>
                <button type="submit" class="w-full app-btn">Sign In</button>
                <p class="text-red-400 text-sm" id="login-error-msg"></p>
            </form>
            <p class="text-sm text-gray-400 mt-4 text-center">
                Need an account? <button onclick="showModal('signup')" class="text-red-400 hover:text-red-300 font-medium">Sign Up</button>
            </p>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="modal-backdrop hidden" onclick="hideModal(event, 'signup')">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border border-red-700/50" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-red-500 mb-4">Sign Up</h3>
            <form id="signup-form" class="space-y-4">
                <input type="text" id="signup-name" placeholder="Display Name" class="app-input" required>
                <input type="email" id="signup-email" placeholder="Email" class="app-input" required>
                <input type="password" id="signup-password" placeholder="Password (min 6 chars)" class="app-input" required>
                <button type="submit" class="w-full app-btn">Create Account</button>
                <p class="text-red-400 text-sm" id="signup-error-msg"></p>
            </form>
            <p class="text-sm text-gray-400 mt-4 text-center">
                Already have an account? <button onclick="showModal('login')" class="text-red-400 hover:text-red-300 font-medium">Log In</button>
            </p>
        </div>
    </div>


    <script>
        // --- Globals & Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Token is no longer used for named users

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentUserData = null;
        let currentView = 'posts';
        let currentDMRecipientId = null;

        // Firestore Paths (Public Data)
        const USERS_COLLECTION = `artifacts/${appId}/public/data/users`;
        const POSTS_COLLECTION = `artifacts/${appId}/public/data/posts`;
        const DMS_COLLECTION = `artifacts/${appId}/public/data/dms`;

        // --- Utility Functions ---

        /**
         * Safely attempts to execute an async function with exponential backoff.
         */
        async function withBackoff(fn, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error(`Max retries reached for function:`, error);
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function getDMId(id1, id2) {
            // Firestore chat ID is based on sorted user IDs (UIDs)
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }

        function formatDate(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }
            return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        // --- UI State Management ---

        function showView(viewName) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            
            // Handle App Header visibility
            if (viewName === 'app') {
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                setView('posts'); // Default to posts inside the app
            } else {
                document.getElementById('app-header').classList.add('hidden');
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
            }
        }

        function setView(viewName) {
            // Only runs if showView('app') is active
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                currentView = viewName;
            }

            // Special handling for DM view to show list first
            if (viewName === 'dms') {
                document.getElementById('dm-list-container').classList.remove('hidden');
                document.getElementById('dm-thread-container').classList.add('hidden');
            }
        }

        function showModal(modalName) {
            document.getElementById(`${modalName}-modal`).classList.remove('hidden');
            // Hide other modal if open
            if (modalName === 'login') {
                document.getElementById('signup-modal').classList.add('hidden');
            } else if (modalName === 'signup') {
                document.getElementById('login-modal').classList.add('hidden');
            }
        }

        function hideModal(event, modalName) {
            // Check if click was on the backdrop itself
            if (event.target.id === `${modalName}-modal`) {
                document.getElementById(`${modalName}-modal`).classList.add('hidden');
                document.getElementById(`${modalName}-error-msg`).textContent = ''; // Clear errors
            }
        }
        
        // --- Core Firebase Initialization & Auth ---

        window.onload = async function() {
            setLogLevel('debug'); // Enable Firestore logging

            // 1. Initialize Firebase
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('loading-screen').innerHTML = '<p class="text-xl text-red-500">Initialization Error. Check console.</p>';
                return;
            }

            // 2. Handle Authentication State Changes
            onAuthStateChanged(auth, async (user) => {
                document.getElementById('loading-screen').classList.add('hidden');
                
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;

                    if (!user.emailVerified) {
                        showView('verify');
                        return;
                    }
                    
                    // User is authenticated and verified
                    await initializeUserProfile(userId, user.displayName, user.photoURL);
                    showView('app');
                    setupListeners();

                } else {
                    // User is signed out
                    userId = null;
                    isAuthReady = false;
                    currentUserData = null;
                    showView('landing');
                }
            });
        }

        async function initializeUserProfile(uid, displayName, photoURL) {
            const userRef = doc(db, USERS_COLLECTION, uid);

            try {
                const docSnap = await withBackoff(() => getDoc(userRef));
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                } else {
                    // Create a new default profile document (runs only once on first sign-up/in)
                    currentUserData = {
                        name: displayName || `Guest-${uid.substring(0, 6)}`,
                        imageUrl: photoURL || `https://placehold.co/40x40/dc2626/ffffff?text=${(displayName || uid).substring(0, 1).toUpperCase()}`,
                        isAdmin: false, // Default is not admin
                        lastActive: serverTimestamp(),
                        userId: uid
                    };
                    await withBackoff(() => setDoc(userRef, currentUserData));
                }
                updateProfileUI(currentUserData);
            } catch (error) {
                console.error("Error initializing user profile:", error);
            }
        }
        
        function updateProfileUI(user) {
            document.getElementById('profile-avatar').src = user.imageUrl;
            document.getElementById('profile-edit-avatar').src = user.imageUrl;
            document.getElementById('profile-name').textContent = user.name;
            document.getElementById('current-user-id').textContent = userId;

            // Update Profile Form fields
            document.getElementById('name-input').value = user.name;
            document.getElementById('image-url-input').value = user.imageUrl;

            // Admin button visibility
            if (user.isAdmin) {
                document.getElementById('admin-nav-btn').classList.remove('hidden');
            } else {
                document.getElementById('admin-nav-btn').classList.add('hidden');
            }
        }

        async function handleSignOut() {
            try {
                await withBackoff(() => signOut(auth));
                showToast('Signed out successfully.', 'gray');
                showView('landing');
            } catch (error) {
                console.error("Sign Out Error:", error);
                showToast('Error signing out.', 'red');
            }
        }

        // --- Auth Modals ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error-msg');
            errorEl.textContent = '';

            try {
                await withBackoff(() => signInWithEmailAndPassword(auth, email, password));
                document.getElementById('login-modal').classList.add('hidden');
                showToast('Login successful!', 'green');
            } catch (error) {
                console.error("Login Error:", error);
                errorEl.textContent = error.message.replace('Firebase: Error (auth/', '').replace(').', '').replace(/-/g, ' ');
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value;
            const errorEl = document.getElementById('signup-error-msg');
            errorEl.textContent = '';

            try {
                const userCredential = await withBackoff(() => createUserWithEmailAndPassword(auth, email, password));
                const user = userCredential.user;

                // Set display name on the Firebase user object
                await withBackoff(() => updateProfile(user, {
                    displayName: name,
                    photoURL: `https://placehold.co/40x40/dc2626/ffffff?text=${name.substring(0, 1).toUpperCase()}`
                }));

                await sendVerificationEmail(false);
                document.getElementById('signup-modal').classList.add('hidden');
                showToast('Account created! Please verify your email.', 'green');
                // The onAuthStateChanged listener will catch this and send to 'verify-view'
            } catch (error) {
                console.error("Signup Error:", error);
                errorEl.textContent = error.message.replace('Firebase: Error (auth/', '').replace(').', '').replace(/-/g, ' ');
            }
        });
        
        async function sendVerificationEmail(showToastMessage) {
            try {
                await withBackoff(() => sendEmailVerification(auth.currentUser));
                if (showToastMessage) {
                    showToast('Verification email resent. Check your inbox!', 'green');
                }
            } catch (error) {
                console.error("Error sending verification email:", error);
                showToast('Failed to send verification email. Try again later.', 'red');
            }
        }

        // --- Realtime Listeners Setup ---

        function setupListeners() {
            if (!isAuthReady || !userId) return;

            // 1. Listen for current user profile changes (already done in onAuthStateChanged, but kept for real-time updates)
            onSnapshot(doc(db, USERS_COLLECTION, userId), (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    updateProfileUI(currentUserData);
                }
            }, (error) => console.error("Error listening to user profile:", error));

            // 2. Listen for Admin Posts (Updates)
            // NOTE: orderBy is kept here for ordering, but be aware of index requirements in Firestore.
            const postsQuery = query(collection(db, POSTS_COLLECTION), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(postsQuery, (snapshot) => {
                renderPosts(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
            }, (error) => console.error("Error listening to posts:", error));

            // 3. Listen for DM list changes (users who have messaged you)
            const dmsQuery = query(collection(db, DMS_COLLECTION), where('participants', 'array-contains', userId));
            onSnapshot(dmsQuery, async (snapshot) => {
                const dmParticipants = new Set();
                snapshot.docs.forEach(doc => {
                    const participants = doc.data().participants;
                    participants.forEach(id => {
                        if (id !== userId) {
                            dmParticipants.add(id);
                        }
                    });
                });
                renderDMList(Array.from(dmParticipants));
            }, (error) => console.error("Error listening to DMs:", error));
        }

        // --- Profile Management ---

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name-input').value;
            const imageUrl = document.getElementById('image-url-input').value;

            if (!name || !imageUrl) return;

            try {
                // 1. Update Firebase Auth Profile (Display Name and Photo URL)
                await withBackoff(() => updateProfile(auth.currentUser, {
                    displayName: name,
                    photoURL: imageUrl
                }));
                
                // 2. Update Firestore Profile Document
                const userRef = doc(db, USERS_COLLECTION, userId);
                await withBackoff(() => updateDoc(userRef, {
                    name: name,
                    imageUrl: imageUrl
                }));
                
                showToast('Profile updated successfully!', 'green');
            } catch (error) {
                console.error("Error updating profile:", error);
                showToast('Error saving profile.', 'red');
            }
        });

        // --- Posts/Updates Management (same as before, minor styling tweaks) ---

        function renderPosts(posts) {
            const listEl = document.getElementById('posts-list');
            listEl.innerHTML = posts.length === 0 ? '<p class="text-gray-400 italic">No updates have been posted yet. Stay tuned!</p>' : '';

            posts.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'bg-gray-800 p-6 rounded-xl shadow-lg border border-red-900/50 hover:border-red-500 transition duration-300';
                const date = post.timestamp ? post.timestamp.toDate().toLocaleDateString() : 'N/A';
                
                // Author name display (using authorId as a fallback if name isn't set)
                const authorDisplay = currentUserData && post.authorId === userId ? currentUserData.name : `Admin ${post.authorId.substring(0, 6)}`;

                postEl.innerHTML = `
                    <h3 class="text-2xl font-bold text-red-500 mb-2">${post.title}</h3>
                    <p class="text-sm text-gray-400 mb-4">Posted by ${authorDisplay} on ${date}</p>
                    <p class="text-gray-200 whitespace-pre-wrap">${post.content}</p>
                `;
                listEl.appendChild(postEl);
            });
        }

        // --- Direct Messaging (DM) Functions (largely the same, relying on new auth) ---

        async function startNewDM() {
            const targetIdInput = document.getElementById('new-dm-id');
            const targetId = targetIdInput.value.trim();

            if (!targetId || targetId === userId) {
                showToast('Invalid User ID or cannot chat with yourself.', 'red');
                return;
            }

            // Check if user exists (now strictly checking UIDs)
            try {
                const targetUserDoc = await withBackoff(() => getDoc(doc(db, USERS_COLLECTION, targetId)));
                if (!targetUserDoc.exists()) {
                    showToast('User ID not found in the system.', 'red');
                    return;
                }
            } catch (error) {
                console.error("Error checking user existence:", error);
                showToast('Error checking user.', 'red');
                return;
            }

            openDMThread(targetId);
            targetIdInput.value = ''; // Clear input
        }

        function openDMThread(recipientId) {
            currentDMRecipientId = recipientId;
            setView('dms');
            document.getElementById('dm-list-container').classList.add('hidden');
            document.getElementById('dm-thread-container').classList.remove('hidden');

            const dmTitleEl = document.getElementById('dm-thread-title');
            dmTitleEl.textContent = `Chat with ${recipientId}`;

            // Listen for messages in the specific chat
            const chatId = getDMId(userId, recipientId);
            const chatRef = doc(db, DMS_COLLECTION, chatId);

            onSnapshot(chatRef, async (docSnap) => {
                const messagesData = docSnap.exists() ? docSnap.data().messages || [] : [];

                // Fetch recipient's name for display
                let recipientName = recipientId;
                try {
                    const userDoc = await withBackoff(() => getDoc(doc(db, USERS_COLLECTION, recipientId)));
                    if (userDoc.exists()) {
                        recipientName = userDoc.data().name;
                        dmTitleEl.textContent = `Chat with ${recipientName}`;
                    }
                } catch (e) {
                    console.error("Could not fetch recipient name:", e);
                }

                renderDMMessages(messagesData, recipientName);
            }, (error) => console.error("Error listening to DM thread:", error));
        }
        
        // ... (closeDMThread, renderDMMessages, sendDM, renderDMList functions remain largely the same)

        function closeDMThread() {
            currentDMRecipientId = null;
            document.getElementById('dm-thread-container').classList.add('hidden');
            document.getElementById('dm-list-container').classList.remove('hidden');
            setView('dms');
        }

        function renderDMMessages(messages, recipientName) {
            const messagesEl = document.getElementById('dm-messages');
            messagesEl.innerHTML = ''; // Clear existing messages

            // Sort in memory as required if orderBy is not used in the query
            messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

            messages.forEach(msg => {
                const isMe = msg.senderId === userId;
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;

                messageEl.innerHTML = `
                    <div class="max-w-xs sm:max-w-md p-3 rounded-xl shadow-md ${isMe ? 'bg-red-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-100 rounded-tl-none border border-gray-600'}">
                        <p class="text-xs font-bold ${isMe ? 'text-gray-200' : 'text-red-400'} mb-1">${isMe ? 'You' : recipientName}</p>
                        <p class="break-words">${msg.text}</p>
                        <p class="text-xs mt-1 text-right ${isMe ? 'text-red-300' : 'text-gray-400'}">${formatDate(msg.timestamp)}</p>
                    </div>
                `;
                messagesEl.appendChild(messageEl);
            });
            // Auto-scroll to bottom
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function sendDM() {
            const inputEl = document.getElementById('dm-input');
            const messageText = inputEl.value.trim();
            const recipientId = currentDMRecipientId;

            if (!messageText || !recipientId) return;

            const chatId = getDMId(userId, recipientId);
            const chatRef = doc(db, DMS_COLLECTION, chatId);

            const message = {
                senderId: userId,
                text: messageText,
                timestamp: serverTimestamp()
            };

            try {
                await withBackoff(async () => {
                    const docSnap = await getDoc(chatRef);
                    if (docSnap.exists()) {
                        // Append message to existing chat
                        await updateDoc(chatRef, {
                            messages: arrayUnion(message)
                        });
                    } else {
                        // Create new chat
                        await setDoc(chatRef, {
                            participants: [userId, recipientId],
                            messages: [message]
                        });
                    }
                });
                inputEl.value = ''; // Clear input
            } catch (error) {
                console.error("Error sending DM:", error);
                showToast('Failed to send message.', 'red');
            }
        }

        async function renderDMList(participantIds) {
            const listEl = document.getElementById('dm-active-list');
            listEl.innerHTML = '';

            if (participantIds.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 italic">No active direct messages.</p>';
                return;
            }

            for (const id of participantIds) {
                if (id === userId) continue;

                let name = id.substring(0, 6); // Default to a truncated ID
                let imageUrl = `https://placehold.co/40x40/1f2937/ffffff?text=U`;
                
                // Fetch user data for name/image
                try {
                    const userDoc = await withBackoff(() => getDoc(doc(db, USERS_COLLECTION, id)));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        name = data.name;
                        imageUrl = data.imageUrl;
                    }
                } catch (e) {
                    console.error("Could not fetch user data for DM list:", e);
                }

                const item = document.createElement('button');
                item.onclick = () => openDMThread(id);
                item.className = 'w-full flex items-center p-3 space-x-3 bg-gray-700 hover:bg-red-900/50 rounded-lg transition duration-150';
                item.innerHTML = `
                    <img src="${imageUrl}" onerror="this.src='https://placehold.co/40x40/1f2937/ffffff?text=U'" alt="Avatar" class="w-10 h-10 rounded-full border border-red-500 object-cover">
                    <div class="text-left flex-grow">
                        <p class="font-medium text-gray-100">${name}</p>
                        <p class="text-xs text-red-400 font-mono">${id.substring(0, 8)}...</p>
                    </div>
                `;
                listEl.appendChild(item);
            }
        }


        // --- Admin Panel Functions ---

        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserData || !currentUserData.isAdmin) {
                showToast('You are not authorized to post updates.', 'red');
                return;
            }

            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;

            try {
                await withBackoff(() => addDoc(collection(db, POSTS_COLLECTION), {
                    title: title,
                    content: content,
                    authorId: userId,
                    timestamp: serverTimestamp()
                }));

                document.getElementById('post-form').reset();
                showToast('Update posted successfully!', 'green');
            } catch (error) {
                console.error("Error creating post:", error);
                showToast('Error creating post.', 'red');
            }
        });

        async function loadAllUsersForAdmin() {
            if (!currentUserData || !currentUserData.isAdmin) return;

            const listEl = document.getElementById('users-list-container');
            listEl.innerHTML = '<p id="users-loading-message" class="text-gray-400">Loading user data...</p>';

            try {
                // Fetch all documents without orderBy to avoid index issues.
                const q = query(collection(db, USERS_COLLECTION));
                const snapshot = await withBackoff(() => getDocs(q));
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No users found.</p>';
                    return;
                }
                
                let users = snapshot.docs.map(doc => doc.data());
                // Sort by name in memory
                users.sort((a, b) => a.name.localeCompare(b.name));

                listEl.innerHTML = '';
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'bg-gray-700 p-4 rounded-lg shadow flex items-center space-x-4 border border-gray-600';
                    userCard.innerHTML = `
                        <img src="${user.imageUrl}" onerror="this.src='https://placehold.co/50x50/1f2937/ffffff?text=U'" alt="Avatar" class="w-12 h-12 rounded-full border-2 ${user.isAdmin ? 'border-red-500' : 'border-gray-500'} object-cover">
                        <div class="truncate">
                            <p class="text-xl font-bold text-gray-100 truncate">${user.name} ${user.isAdmin ? '<span class="text-red-500 text-sm">(ADMIN)</span>' : ''}</p>
                            <p class="text-sm font-mono text-red-400 break-all">ID: ${user.userId}</p>
                            <p class="text-sm text-gray-400 truncate">Email: ${user.email || 'N/A'}</p>
                        </div>
                    `;
                    listEl.appendChild(userCard);
                });

            } catch (error) {
                console.error("Error loading all users for admin:", error);
                listEl.innerHTML = '<p class="text-red-500">Error loading users. Check console.</p>';
            }
        }

        function setAdminTab(tab) {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`admin-${tab}-tab`).classList.remove('hidden');

            document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            // Refresh user list when switching to users tab
            if (tab === 'users') {
                loadAllUsersForAdmin();
            }
        }


        // --- Toast / Notification System ---
        function showToast(message, type = 'gray') {
            const colors = {
                'red': 'bg-red-600',
                'green': 'bg-green-600',
                'gray': 'bg-gray-600'
            };
            const colorClass = colors[type] || colors['gray'];
            
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'fixed bottom-5 right-5 z-50 space-y-2';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-xl text-white ${colorClass} transition-opacity duration-300 opacity-0`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.remove('opacity-0'), 100);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

    </script>
</body>
</html>
